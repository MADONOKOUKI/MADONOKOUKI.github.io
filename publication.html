<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Publications — Koki Madono</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <header class="wrap">
    <nav class="nav">
      <a href="./">Home</a>
      <a href="publication.html" aria-current="page">Publications</a>
    </nav>
    <h1>Publications</h1>

    <!-- フィルタボタン -->
    <div class="pub-filters">
      <button data-filter="all" class="active">All</button>
      <button data-filter="journal">Journal</button>
      <button data-filter="conference">Conference</button>
      <button data-filter="selected">Selected</button>
      <button data-filter="top-tier">Top-tier</button>
    </div>
  </header>

  <main id="pub-root" class="wrap">
    <noscript><p>Please enable JavaScript to view the publication list.</p></noscript>
  </main>

  <footer class="wrap small">© Koki Madono</footer>

  <script>
  (async ()=>{
    const root = document.getElementById('pub-root');
    let data = [];

    try {
      const res = await fetch('data/publications.json', {cache:'no-store'});
      if(!res.ok) throw new Error('failed');
      data = await res.json();
    } catch(e) {
      root.innerHTML = '<p>Failed to load publications. Please check data/publications.json.</p>';
      return;
    }

    // 年ごとにまとめる
    const byYear = {};
    for(const p of data){ (byYear[p.year] ??= []).push(p); }
    const years = Object.keys(byYear).map(Number).sort((a,b)=>b-a);

    const filters = document.querySelectorAll('.pub-filters button');

    function render(filter='all'){
      root.innerHTML = '';
      for(const y of years){
        const items = byYear[y].filter(p => {
          if(filter==='all') return true;
          if(filter==='journal' || filter==='conference') return p.type===filter;
          if(p.tags && p.tags.includes(filter)) return true; // タグで選択
          return false;
        });
        if(items.length===0) continue;

        const h2 = document.createElement('h2');
        h2.className = 'pub-year';
        h2.textContent = y;
        root.appendChild(h2);

        for(const p of items){
          const art = document.createElement('article');
          art.className = 'pub-item';

          // 左の画像
          if(p.thumb){
            const img = document.createElement('img');
            img.className = 'pub-thumb';
            img.src = p.thumb;
            img.alt = p.title || '';
            art.appendChild(img);
          }

          // 右の情報
          const info = document.createElement('div');
          info.className = 'pub-info';

          const h3 = document.createElement('h3');
          h3.className = 'pub-title';
          h3.textContent = p.title;
          info.appendChild(h3);

          const a1 = document.createElement('p');
          a1.className = 'pub-authors';
          a1.innerHTML = (p.authors || '')
            .replace(/K\.?\s*Madono/gi,'<strong>K. Madono</strong>')
            .replace(/Koki\s+Madono/gi,'<strong>Koki Madono</strong>');
          info.appendChild(a1);

          const a2 = document.createElement('p');
          a2.className = 'pub-venue';
          a2.textContent = `${p.venue || ''}, ${p.year}`;
          info.appendChild(a2);

          // バッジ行
          if(p.links?.length || p.abstract || p.bibtex){
            const pLinks = document.createElement('p');
            pLinks.className = 'pub-links';

            // リンク
            if(p.links?.length){
              for(const lk of p.links){
                const a = document.createElement('a');
                a.className = 'badge';
                a.href = lk.url;
                a.textContent = lk.label;
                if(/^https?:/.test(lk.url)){
                  a.target = '_blank';
                  a.rel = 'noopener noreferrer';
                }
                pLinks.appendChild(a);
              }
            }

            // Abstract
            if(p.abstract){
              const btn = document.createElement('button');
              btn.className = 'badge';
              btn.textContent = 'Abstract';
              btn.addEventListener('click', ()=>{
                const dialog = document.createElement('dialog');
                dialog.className = 'pub-dialog';
                dialog.innerHTML = `<h3>Abstract</h3><p>${p.abstract}</p>
                                    <form method="dialog"><button>Close</button></form>`;
                document.body.appendChild(dialog);
                dialog.showModal();
                dialog.addEventListener('close', ()=>dialog.remove());
              });
              pLinks.appendChild(btn);
            }

            // BibTeX
            if(p.bibtex){
              const btn = document.createElement('button');
              btn.className = 'badge';
              btn.textContent = 'BibTeX';
              btn.addEventListener('click', ()=>{
                const bib = (p.bibtex||'').replace(/\\n/g,'\n');
                const dialog = document.createElement('dialog');
                dialog.className = 'pub-dialog';
                dialog.innerHTML = `<h3>BibTeX</h3><pre>${bib}</pre>
                                    <form method="dialog"><button>Close</button></form>`;
                document.body.appendChild(dialog);
                dialog.showModal();
                dialog.addEventListener('close', ()=>dialog.remove());
              });
              pLinks.appendChild(btn);
            }

            info.appendChild(pLinks);
          }

          art.appendChild(info);
          root.appendChild(art);
        }
      }
    }

    filters.forEach(b=>{
      b.addEventListener('click', ()=>{
        filters.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        render(b.dataset.filter);
      });
    });

    render('all');
  })();
  </script>
</body>
</html>
